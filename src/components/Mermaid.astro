---
/**
 * Client-side Mermaid renderer. Loads Mermaid from CDN (no ESM import), finds mermaid code
 * blocks, replaces them with div.mermaid, and runs mermaid.run() so the diagram renders as SVG.
 */
---

<script client:load>
  function runMermaid() {
    let blocks = document.querySelectorAll('pre code.language-mermaid, pre code[class*="mermaid"]');
    if (blocks.length === 0) {
      const allPre = document.querySelectorAll('pre code');
      blocks = Array.from(allPre).filter((code) => {
        const t = (code.textContent || '').trim();
        return /^\s*(flowchart|graph|sequenceDiagram|erDiagram|classDiagram|stateDiagram|pie|gitGraph|journey)\b/.test(t);
      });
    }
    if (blocks.length === 0) return;

    function render(mermaid) {
      try {
        mermaid.initialize({ startOnLoad: false, theme: 'dark' });
        blocks.forEach((code) => {
          const pre = code.closest('pre');
          if (!pre) return;
          const text = code.textContent?.trim() ?? '';
          const wrapper = document.createElement('div');
          wrapper.className = 'mermaid-chart-wrapper';
          const div = document.createElement('div');
          div.className = 'mermaid';
          div.textContent = text;
          wrapper.appendChild(div);
          const hint = document.createElement('span');
          hint.className = 'mermaid-expand-hint';
          hint.textContent = 'Click to enlarge';
          hint.setAttribute('aria-hidden', 'true');
          wrapper.appendChild(hint);
          pre.replaceWith(wrapper);
        });
        Promise.resolve(mermaid.run()).then(() => {
          document.querySelectorAll('.mermaid-chart-wrapper').forEach((wrapper) => {
            const hint = wrapper.querySelector('.mermaid-expand-hint');
            wrapper.addEventListener('click', () => {
              const isExpanding = !wrapper.classList.contains('mermaid-expanded');
              if (isExpanding) {
                const startWidth = wrapper.getBoundingClientRect().width;
                wrapper.style.width = `${startWidth}px`;
                wrapper.style.marginLeft = '0';
                wrapper.style.marginRight = '0';
                wrapper.classList.add('mermaid-expanded');
                requestAnimationFrame(() => {
                  requestAnimationFrame(() => {
                    wrapper.style.width = '100vw';
                    wrapper.style.marginLeft = 'calc(50% - 50vw)';
                    wrapper.style.marginRight = 'calc(50% - 50vw)';
                  });
                });
              } else {
                const currentWidth = wrapper.getBoundingClientRect().width;
                const parentWidth = wrapper.parentElement?.getBoundingClientRect().width ?? currentWidth;
                wrapper.style.width = `${currentWidth}px`;
                wrapper.style.marginLeft = 'calc(50% - 50vw)';
                wrapper.style.marginRight = 'calc(50% - 50vw)';
                wrapper.classList.remove('mermaid-expanded');
                requestAnimationFrame(() => {
                  requestAnimationFrame(() => {
                    wrapper.style.width = `${parentWidth}px`;
                    wrapper.style.marginLeft = '0';
                    wrapper.style.marginRight = '0';
                    setTimeout(() => {
                      wrapper.style.width = '';
                      wrapper.style.marginLeft = '';
                      wrapper.style.marginRight = '';
                    }, 350);
                  });
                });
              }
              if (hint) {
                hint.textContent = isExpanding ? 'Click to collapse' : 'Click to enlarge';
              }
            });
          });
        });
      } catch (err) {
        console.error('[Mermaid] Failed to render diagrams:', err);
      }
    }

    if (window.mermaid) {
      render(window.mermaid);
      return;
    }
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js';
    script.onload = () => render(window.mermaid);
    script.onerror = () => console.error('[Mermaid] Failed to load Mermaid from CDN');
    document.head.appendChild(script);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => requestAnimationFrame(runMermaid));
  } else {
    requestAnimationFrame(runMermaid);
  }
</script>
